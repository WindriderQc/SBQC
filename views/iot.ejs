<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/mainHead', { title: 'IoT Devices' }) %>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
</head>
<body class="light-grey" id="page-top">

<%- include('partials/miniNav') %>

<div class="main" style="margin-left:300px;margin-top:43px;">
    <div class="container-fluid bg-3">

      <div class="row">
         <% regDevices.forEach(sender =>{ %>
            <div class="row mt-2 col-sm-12">
               <%- include('partials/graph/valueCard', {name: "ID ",                defaultValue: sender.id, units: "",     smWidth: 2, domID: sender.id+"id_id"      }); %>
               <%- include('partials/graph/rssGauge',  { name: "Wifi",        defaultValue: -100,   units: " dBm", smWidth: 3, domID: sender.id+"rss_id",  divHeight: "120px" }); %>
               <%- include('partials/graph/valueCard', { name: "CPU temperature ",  defaultValue: 0,      units: "Â°C",   smWidth: 2, domID: sender.id+"temp_id"    }); %>
               <%- include('partials/graph/valueCard', { name: "Battery",           defaultValue: 0,      units: "v",    smWidth: 2, domID: sender.id+"batt_id"    }); %>
               <%- include('partials/graph/valueCard', { name: "Humidity",          defaultValue: 0,      units: "%",    smWidth: 2, domID: sender.id+"humid_id"   }); %>
            </div>
         <% }) %>
      </div>

      <div class="row  mt-2">
         <div class='col-sm-12'>
            <div class="card">
               <div class='card-body'>
                <div class="row">
                    <div class='col-sm-4'>Registered</div>
                    <div class='col-sm-3'>Latest post</div>
                 </div>
                  <div class="row">
                     <div class='col-sm-4'><small><div id='devicesList'></div></small></div>
                     <div class='col-sm-3'><small><div id='statusList'></div></small></div>
                  </div>
               </div>
            </div>
         </div>
      </div>

        <div class="form-group green-border mt-2">
            <label for="streamTextArea">Streaming from Esp32(s)</label>
            <textarea class="form-control" id="streamTextArea" rows="32"></textarea>
        </div>


      <div class="row mt-2">
         <div class="col-sm-12">
            <div class="card ">
               <form>
                  <input type='text' id='topic' value='esp32/boot'>
                  <input type='text' id='msg' value='ESP_35030'>
                  <button type='button' onclick=mqttPost()>MQTT Publish</button>
               </form>
            </div>
         </div>
      </div>

      <%- include('partials/iot/mqtt-docs') %>
      <%- include('partials/iot/device-controls') %>

      <% if (locals.user) { %>
      <div class="row mt-2">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">Device Configuration Profiles</h5>
                            <p class="text-muted mb-0">Manage device configuration profiles in DataAPI</p>
                        </div>
                        <a href="https://data.specialblend.ca/profiles" target="_blank" class="btn btn-primary">
                            <i class="fas fa-cog me-2"></i>Manage Profiles
                            <i class="fas fa-external-link-alt ms-2"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
      </div>
      <% } else { %>
      <div class="row mt-2">
        <div class="col-sm-12">
            <%- include('partials/loginPrompt', { feature: 'manage device configuration profiles' }) %>
        </div>
      </div>
      <% } %>

 <!-- End Container -->
    </div>
<%- include('partials/footer') %>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // Pass data from EJS to our external script
  window.ejsData = {
    regDevices: <%- JSON.stringify(regDevices) %>
  };
</script>

<script type="text/javascript" src="js/p5.speech.js"></script>
<script type="text/javascript" src="js/nestor.js"></script>
<script src="/js/dashboard.js"></script>
<script src="/js/iot.js"></script> <%# New script for the IoT page %>
</body>
</html>